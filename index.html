const PROJECTS_API = "https://api-eu.ppm.express/api/v1/projects";
const RESOURCES_API = "https://api-eu.ppm.express/@%40liquid/v1.0/resources";
// ğŸ” Shared CORS headers
const corsHeaders = {
 "Access-Control-Allow-Origin": "*",
 "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
 "Access-Control-Allow-Headers": "Content-Type",
};
// ğŸ“¦ Fetch filtered projects from PPM Express
async function fetchProjects(pmNames, start, end, apiKey) {
 const res = await fetch(PROJECTS_API, {
   headers: { "Authorization": `Bearer ${apiKey}` }
 });
 const { value } = await res.json();
 const filtered = value.filter(p => {
   const name = p.OwnerName?.trim();
   const startDate = new Date(p.StartDate);
   return pmNames.includes(name) &&
          startDate >= new Date(start) &&
          startDate <= new Date(end);
 });
 return filtered;
}
// ğŸ“Œ Create a new project
async function createProject(name, owner, apiKey) {
 const body = {
   attributes: {
     Name: name,
     Owner: [{ search: owner }],
     StartDate: new Date().toISOString(),
     EndDate: new Date(Date.now() + 90 * 86400000).toISOString(),
     OverallStatus: "Not Started"
   }
 };
 const res = await fetch(PROJECTS_API, {
   method: "POST",
   headers: {
     "Authorization": `Bearer ${apiKey}`,
     "Content-Type": "application/json"
   },
   body: JSON.stringify(body)
 });
 const json = await res.json();
 return {
   name,
   owner,
   id: json.id
 };
}
// ğŸ“‹ Fetch list of unique PMs (resources)
async function fetchPMList(apiKey, search = "") {
 const res = await fetch(RESOURCES_API, {
   headers: {
     "Authorization": `Bearer ${apiKey}`,
     "Accept": "application/json"
   }
 });
 const { value } = await res.json();
 if (!value || !Array.isArray(value)) {
   console.log("âš ï¸ No resource values returned.");
   return [];
 }
 const uniquePMs = Array.from(
   new Set(
     value
       .map(r => r.Name?.trim())
       .filter(name => name && name.toLowerCase().includes(search.toLowerCase()))
   )
 );
 console.log(`ğŸ” Found ${uniquePMs.length} PMs matching: "${search}"`);
 return uniquePMs;
}
// ğŸŒ Cloudflare Worker entry point
export default {
 async fetch(request, env, ctx) {
   const url = new URL(request.url);
   const apiKey = env.api_ppm;
   // âœ… CORS preflight
   if (request.method === "OPTIONS") {
     return new Response("OK", { headers: corsHeaders });
   }
   try {
     // ğŸ“ POST /api/projects
     if (url.pathname === "/api/projects" && request.method === "POST") {
       const { pmNames, start, end } = await request.json();
       const data = await fetchProjects(pmNames, start, end, apiKey);
       return new Response(JSON.stringify(data), {
         headers: { "Content-Type": "application/json", ...corsHeaders }
       });
     }
     // âœ… POST /api/create
     if (url.pathname === "/api/create" && request.method === "POST") {
       const { name, owner } = await request.json();
       const created = await createProject(name, owner, apiKey);
       return new Response(JSON.stringify(created), {
         headers: { "Content-Type": "application/json", ...corsHeaders }
       });
     }
     // ğŸ” GET /api/pms?search=name
     if (url.pathname === "/api/pms" && request.method === "GET") {
       const search = url.searchParams.get("search") || "";
       const pms = await fetchPMList(apiKey, search);
       return new Response(JSON.stringify(pms), {
         headers: { "Content-Type": "application/json", ...corsHeaders }
       });
     }
     // ğŸŸ¢ Default route
     return new Response("Working âœ…", {
       status: 200,
       headers: { "Content-Type": "text/plain", ...corsHeaders }
     });
   } catch (err) {
     console.error("âŒ Worker error:", err.message);
     return new Response("Internal Server Error", {
       status: 500,
       headers: { ...corsHeaders }
     });
   }
 }
};